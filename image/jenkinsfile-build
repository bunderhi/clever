pipeline {
  agent any
  parameters {
    string(name: 'IMAGE_NAME', defaultValue: 'clever_noname.img', description: 'Output image file name')
    string(name: 'IMAGE_VERSION', defaultValue: 'No version', description: 'Image version')

    string(name: 'WORKSPACE', defaultValue: '/mnt/hdd_builder/workspace', description: 'Workspace')
    string(name: 'MOUNT_POINT', defaultValue: '/mnt/hdd_builder/image', description: 'Mount point')

    string(name: 'RPI_DONWLOAD_URL', defaultValue: 'https://downloads.raspberrypi.org/raspbian_lite/images/raspbian_lite-2017-12-01/2017-11-29-raspbian-stretch-lite.zip')
    // TODO: Add mirrorparameters
  }
  environment {
    DEBIAN_FRONTEND = 'noninteractive'
    LANG = 'C.UTF-8'
    LC_ALL = 'C.UTF-8'
  }
  stages {
    stage('Get image') {
      steps {
        sh "${params.WORKSPACE}/image/image_config.sh get_image ${params.WORKSPACE} ${params.RPI_DONWLOAD_URL} ${params.IMAGE_NAME}"
      }
    }
    stage('Resize FS') {
      environment {
        SIZE = '8G'
      }
      steps {
        sh "${params.WORKSPACE}/image/image_config.sh resize_fs $SIZE ${params.WORKSPACE} ${params.IMAGE_NAME}"
      }
    }
    stage('Configure interfaces') {
      environment {
        EXECUTE_FILE = 'iface.sh'
      }
      steps {
        sh "${params.WORKSPACE}/image/image_config.sh execute ${params.WORKSPACE}/${params.IMAGE_NAME} ${params.MOUNT_POINT} ${params.WORKSPACE}/image/$EXECUTE_FILE"
      }
    }
    stage('Initialize image') {
      environment {
        EXECUTE_FILE = 'init.sh'
      }
      // TODO: Transfer apps.sh initialisation code here
      steps {
        sh "${params.WORKSPACE}/image/image_config.sh execute ${params.WORKSPACE}/${params.IMAGE_NAME} ${params.MOUNT_POINT} ${params.WORKSPACE}/image/$EXECUTE_FILE ${params.IMAGE_VERSION} $(basename ${params.RPI_ZIP_NAME})"
      }
    }
    stage('Install Apps') {
      environment {
        EXECUTE_FILE = 'apps.sh'
      }
      steps {
        sh "${params.WORKSPACE}/image/image_config.sh execute ${params.WORKSPACE}/${params.IMAGE_NAME} ${params.MOUNT_POINT} ${params.WORKSPACE}/image/$EXECUTE_FILE"
      }
    }
    stage('Install ROS') {
      environment {
        EXECUTE_FILE = 'ros.sh'
      }
      steps {
        sh "${params.WORKSPACE}/image/image_config.sh execute ${params.WORKSPACE}/${params.IMAGE_NAME} ${params.MOUNT_POINT} ${params.WORKSPACE}/image/$EXECUTE_FILE"
      }
    }
    // TODO: Add finalising step, transfer mirror removal from ros.sh
  }
}
